<div class="analytics-dashboard">
  <!-- Header with Filters -->
  <div class="dashboard-header">
    <div class="header-content">
      <h1 class="dashboard-title">{{ 'nav.analytics' | translate }}</h1>
      <p class="dashboard-description">{{ 'analytics.description' | translate }}</p>
    </div>
    
    <div class="filters-section">
      <div class="filter-group">
        <label for="period-select">Per√≠odo:</label>
        <select id="period-select" [(ngModel)]="selectedPeriod" (change)="onFilterChange()" class="filter-select">
          <option value="year">A√±o</option>
          <option value="month">Mes</option>
          <option value="week">Semana</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="year-select">A√±o:</label>
        <select id="year-select" [(ngModel)]="selectedYear" (change)="onFilterChange()" class="filter-select">
          <option *ngFor="let year of availableYears" [value]="year">{{ year }}</option>
        </select>
      </div>
      
      <div class="filter-group" *ngIf="selectedPeriod === 'month'">
        <label for="month-select">Mes:</label>
        <select id="month-select" [(ngModel)]="selectedMonth" (change)="onFilterChange()" class="filter-select">
          <option value="">Todos los meses</option>
          <option value="1">Enero</option>
          <option value="2">Febrero</option>
          <option value="3">Marzo</option>
          <option value="4">Abril</option>
          <option value="5">Mayo</option>
          <option value="6">Junio</option>
          <option value="7">Julio</option>
          <option value="8">Agosto</option>
          <option value="9">Septiembre</option>
          <option value="10">Octubre</option>
          <option value="11">Noviembre</option>
          <option value="12">Diciembre</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Overview Stats Cards -->
  <div class="stats-section" *ngIf="dashboardData && !isLoading.overview">
    <div class="stats-grid">
      <div class="stat-card total-spent">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
          <div class="stat-value">{{ formatCurrency(dashboardData?.overview?.total_spent || 0) }}</div>
          <div class="stat-label">Total Gastado</div>
        </div>
      </div>
      
      <div class="stat-card total-receipts">
        <div class="stat-icon">üìÑ</div>
        <div class="stat-content">
          <div class="stat-value">{{ dashboardData?.overview?.total_receipts || 0 }}</div>
          <div class="stat-label">Recibos Analizados</div>
        </div>
      </div>
      
      <div class="stat-card total-products">
        <div class="stat-icon">üõçÔ∏è</div>
        <div class="stat-content">
          <div class="stat-value">{{ dashboardData?.overview?.total_products || 0 }}</div>
          <div class="stat-label">Productos Comprados</div>
        </div>
      </div>
      
      <div class="stat-card avg-receipt">
        <div class="stat-icon">üìä</div>
        <div class="stat-content">
          <div class="stat-value">{{ formatCurrency(dashboardData?.overview?.avg_receipt || 0) }}</div>
          <div class="stat-label">Promedio por Recibo</div>
        </div>
      </div>
      
      <div class="stat-card supermarkets">
        <div class="stat-icon">üè™</div>
        <div class="stat-content">
          <div class="stat-value">{{ dashboardData?.overview?.unique_supermarkets || 0 }}</div>
          <div class="stat-label">Supermercados Visitados</div>
        </div>
      </div>
      
      <div class="stat-card days-analyzed">
        <div class="stat-icon">‚è∞</div>
        <div class="stat-content">
          <div class="stat-value">{{ dashboardData?.overview?.days_analyzed || 0 }}</div>
          <div class="stat-label">D√≠as Analizados</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State for Overview -->
  <div class="loading-section" *ngIf="isLoading.overview">
    <div class="loading-spinner">Cargando datos generales...</div>
  </div>

  <!-- No Data State -->
  <div class="no-data-section" *ngIf="!isLoading.overview && !dashboardData">
    <div class="no-data-message">
      <h3>No hay datos disponibles</h3>
      <p>A√∫n no hay recibos analizados para mostrar estad√≠sticas. Sube algunos recibos primero.</p>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="charts-section">
    <!-- Monthly Comparison Chart -->
    <div class="chart-container">
      <div class="chart-header">
        <h3 class="chart-title">Comparaci√≥n Mensual</h3>
        <div class="chart-insights" *ngIf="monthlyData?.insights">
          <div class="insight best-month" *ngIf="monthlyData?.insights?.best_month">
            <span class="insight-icon">üèÜ</span>
            <span class="insight-text">
              Mejor mes: {{ monthlyData?.insights?.best_month?.month_name }} 
              ({{ monthlyData?.insights?.best_month ? formatCurrency(monthlyData?.insights?.best_month?.total_spent) : '' }})
            </span>
          </div>
        </div>
      </div>
      <div class="chart-content">
        <canvas #monthlyChart *ngIf="!isLoading.monthly && monthlyData" width="400" height="200" style="min-height: 200px;"></canvas>
        <div class="loading-chart" *ngIf="isLoading.monthly">Cargando gr√°fico mensual...</div>
        <div class="no-data-chart" *ngIf="!isLoading.monthly && !monthlyData">No hay datos mensuales disponibles</div>
      </div>
    </div>

    <!-- Supermarket Distribution Chart -->
    <div class="chart-container">
      <div class="chart-header">
        <h3 class="chart-title">Distribuci√≥n por Supermercado</h3>
      </div>
      <div class="chart-content">
        <canvas #supermarketChart *ngIf="!isLoading.overview && dashboardData" width="400" height="200" style="min-height: 200px;"></canvas>
        <div class="loading-chart" *ngIf="isLoading.overview">Cargando gr√°fico de supermercados...</div>
        <div class="no-data-chart" *ngIf="!isLoading.overview && !dashboardData">No hay datos de supermercados disponibles</div>
      </div>
    </div>

    <!-- Price Trends Chart -->
    <div class="chart-container full-width">
      <div class="chart-header">
        <h3 class="chart-title">Tendencias de Precio - Top 3 Productos</h3>
        <div class="trends-summary" *ngIf="priceData?.price_trends">
          <div class="trend-item" *ngFor="let trend of priceData?.price_trends">
            <span class="product-name">{{ trend.product_name }}</span>
            <span class="trend-indicator" [class]="getTrendClass(trend.trend_direction)">
              {{ getTrendIcon(trend.trend_direction) }} {{ trend.trend_percentage }}%
            </span>
          </div>
        </div>
      </div>
      
      <!-- Individual charts for each product -->
      <div class="individual-trends" *ngIf="priceData?.price_trends && (priceData?.price_trends?.length || 0) > 0">
        <div class="product-trend-chart" *ngFor="let product of priceData?.price_trends; let i = index">
          <div class="product-chart-header">
            <h4>{{ product.product_name }}</h4>
            <div class="product-stats">
              <span class="trend-badge" [class]="getTrendClass(product.trend_direction)">
                {{ getTrendIcon(product.trend_direction) }} {{ product.trend_percentage }}%
              </span>
              <span class="total-spent">Total gastado: {{ formatCurrency(product.total_spent) }}</span>
            </div>
          </div>
          <div class="chart-content">
            <canvas [id]="'productChart-' + i" 
                    width="400" 
                    height="200" 
                    style="min-height: 200px;">
            </canvas>
          </div>
        </div>
      </div>
      
      <div class="loading-chart" *ngIf="isLoading.trends">Cargando tendencias de precio...</div>
      <div class="no-data-chart" *ngIf="!isLoading.trends && !priceData">No hay datos de tendencias disponibles</div>
    </div>

    <!-- Savings Potential Chart -->
    <div class="chart-container full-width">
      <div class="chart-header">
        <h3 class="chart-title">Potencial de Ahorro por Producto</h3>
        <div class="savings-summary" *ngIf="savingsData?.total_potential_saving">
          <div class="total-savings">
            <span class="savings-icon">üí∞</span>
            <span class="savings-text">
              Ahorro total potencial: {{ savingsData && savingsData.total_potential_saving ? formatCurrency(savingsData.total_potential_saving) : '‚Ç¨0.00' }}
            </span>
          </div>
        </div>
      </div>
      <div class="chart-content">
        <canvas #savingsChart *ngIf="!isLoading.savings && savingsData" width="800" height="300" style="min-height: 300px;"></canvas>
        <div class="loading-chart" *ngIf="isLoading.savings">Cargando an√°lisis de ahorros...</div>
        <div class="no-data-chart" *ngIf="!isLoading.savings && !savingsData">No hay datos de ahorros disponibles</div>
      </div>
    </div>
  </div>

  <!-- Top Products Section -->
  <div class="insights-section" *ngIf="dashboardData?.top_products && !isLoading.overview">
    <h3 class="section-title">Top 3 Productos M√°s Comprados</h3>
    <div class="products-grid">
      <div class="product-card" *ngFor="let product of dashboardData?.top_products; let i = index">
        <div class="product-rank">{{ i + 1 }}</div>
        <div class="product-info">
          <h4 class="product-name">{{ product.name }}</h4>
          <div class="product-stats">
            <div class="stat">
              <span class="stat-label">Total gastado:</span>
              <span class="stat-value">{{ formatCurrency(product.total_spent) }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Cantidad total:</span>
              <span class="stat-value">{{ product.total_quantity }}</span>
            </div>
            <div class="stat">
              <span class="stat-label">Precio promedio:</span>
              <span class="stat-value">{{ formatCurrency(product.avg_price) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Savings Analysis Section -->
  <div class="savings-section" *ngIf="savingsData?.savings_analysis && !isLoading.savings">
    <h3 class="section-title">An√°lisis de Ahorros entre Supermercados</h3>
    <div class="savings-list">
      <div class="savings-item" *ngFor="let saving of savingsData?.savings_analysis?.slice(0, 5)">
        <div class="saving-product">
          <h4 class="saving-product-name">{{ saving.product_name }}</h4>
          <div class="saving-details">
            <div class="cheapest">
              <span class="label">M√°s barato en:</span>
              <span class="supermarket">{{ saving.cheapest_supermarket.name }}</span>
              <span class="price">{{ formatCurrency(saving.cheapest_supermarket.avg_price) }}</span>
            </div>
            <div class="expensive">
              <span class="label">M√°s caro en:</span>
              <span class="supermarket">{{ saving.most_expensive_supermarket.name }}</span>
              <span class="price">{{ formatCurrency(saving.most_expensive_supermarket.avg_price) }}</span>
            </div>
          </div>
        </div>
        <div class="saving-amount">
          <div class="potential-saving">{{ formatCurrency(saving.potential_saving) }}</div>
          <div class="saving-percentage">{{ saving.saving_percentage }}% ahorro</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Period Info -->
  <div class="period-info" *ngIf="dashboardData?.overview && !isLoading.overview">
    <div class="period-card">
      <h4>Per√≠odo de An√°lisis</h4>
      <div class="period-details">
        <div class="period-item" *ngIf="dashboardData?.overview?.first_receipt">
          <span class="label">Primer recibo:</span>
          <span class="value">{{ dashboardData?.overview?.first_receipt ? formatDate(dashboardData?.overview?.first_receipt!) : '' }}</span>
        </div>
        <div class="period-item" *ngIf="dashboardData?.overview?.last_receipt">
          <span class="label">√öltimo recibo:</span>
          <span class="value">{{ dashboardData?.overview?.last_receipt ? formatDate(dashboardData?.overview?.last_receipt!) : '' }}</span>
        </div>
      </div>
    </div>
  </div>
</div>
